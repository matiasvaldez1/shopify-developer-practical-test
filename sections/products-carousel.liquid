{{ 'product-carousel.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign section_id = 'wine-carousel-' | append: section.id
-%}

<div class="wine-carousel" id="{{ section_id }}">
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <div class="section-header text-center">
        <h2 class="section-title">{{ section.settings.heading }}</h2>
        {% if section.settings.description != blank %}
          <div class="section-description">{{ section.settings.description }}</div>
        {% endif %}
      </div>
    {% endif %}

    <div class="carousel-container">
      <button class="carousel-nav carousel-nav--prev" data-direction="prev">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      
      <div class="carousel-wrapper">
        <div class="carousel-track">
          <!-- Updated to show wine collection products with proper badges -->
          {% assign collection = collections[section.settings.collection] %}
          {% if collection.products.size > 0 %}
            {% for product in collection.products limit: section.settings.products_to_show %}
              <div class="carousel-slide product-slide">
                <div class="product-card">
                  <div class="product-card__media">
                    {% if product.featured_media %}
                      <img 
                        src="{{ product.featured_media | image_url: width: 300 }}"
                        alt="{{ product.featured_media.alt | escape }}"
                        loading="lazy"
                        width="300"
                        height="{{ 300 | divided_by: product.featured_media.aspect_ratio | round }}"
                      >
                    {% else %}
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    {% endif %}
                    
                    <!-- Product badges matching the image design -->
                    {% assign badge_text = '' %}
                    {% assign badge_class = '' %}
                    
                    {% if product.tags contains 'robs-pick' %}
                      {% assign badge_text = "Rob's Pick" %}
                      {% assign badge_class = 'robs-pick' %}
                    {% elsif product.tags contains 'top-seller' %}
                      {% assign badge_text = 'Top Seller' %}
                      {% assign badge_class = 'top-seller' %}
                    {% elsif product.tags contains 'limited-release' %}
                      {% assign badge_text = 'Limited Release' %}
                      {% assign badge_class = 'limited-release' %}
                    {% elsif product.tags contains 'splurge-worthy' %}
                      {% assign badge_text = 'Splurge Worthy' %}
                      {% assign badge_class = 'splurge-worthy' %}
                    {% elsif product.compare_at_price > product.price %}
                      {% assign badge_text = 'Sale' %}
                      {% assign badge_class = 'sale' %}
                    {% endif %}
                    
                    {% if badge_text != '' %}
                      <div class="product-card__badge product-card__badge--{{ badge_class }}">
                        {{ badge_text }}
                      </div>
                    {% endif %}

                    <!-- Quick View Icon -->
                    <button class="product-card__quick-view" aria-label="Quick view">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </button>
                  </div>
                  
                  <div class="product-card__info">
                    <h3 class="product-card__title">
                      <a href="{{ product.url }}">{{ product.title }}</a>
                    </h3>
                    
                    <!-- Price display matching the image format -->
                    <div class="product-card__price">
                      {% if product.compare_at_price > product.price %}
                        <span class="price price--sale">${{ product.price | money_without_currency }}</span>
                        <span class="price price--compare">${{ product.compare_at_price | money_without_currency }}</span>
                      {% else %}
                        <span class="price">${{ product.price | money_without_currency }}</span>
                      {% endif %}
                    </div>
                    
                    <!-- Add to Cart Button matching the image design -->
                    {% if product.available %}
                      {% if product.variants.size == 1 %}
                        <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form">
                          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                          <button type="submit" class="btn btn--add-to-cart">
                            Add to Cart
                          </button>
                        </form>
                      {% else %}
                        <a href="{{ product.url }}" class="btn btn--add-to-cart">
                          Add to Cart
                        </a>
                      {% endif %}
                    {% else %}
                      <button class="btn btn--add-to-cart btn--disabled" disabled>
                        Out of Stock
                      </button>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          {% endif %}
        </div>
      </div>
      
      <button class="carousel-nav carousel-nav--next" data-direction="next">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('#{{ section_id }} .carousel-container');
    
    if (carousel) {
      const track = carousel.querySelector('.carousel-track');
      const slides = carousel.querySelectorAll('.carousel-slide');
      const prevBtn = carousel.querySelector('.carousel-nav--prev');
      const nextBtn = carousel.querySelector('.carousel-nav--next');
      
      let currentIndex = 0;
      const slidesToShow = window.innerWidth >= 1200 ? 4 : window.innerWidth >= 768 ? 3 : window.innerWidth >= 480 ? 2 : 1;
      const maxIndex = Math.max(0, slides.length - slidesToShow);
      
      function updateCarousel() {
        const slideWidth = slides[0].offsetWidth + 20; // 20px gap
        track.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
        
        prevBtn.style.opacity = currentIndex === 0 ? '0.5' : '1';
        nextBtn.style.opacity = currentIndex >= maxIndex ? '0.5' : '1';
      }
      
      prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      });
      
      nextBtn.addEventListener('click', () => {
        if (currentIndex < maxIndex) {
          currentIndex++;
          updateCarousel();
        }
      });
      
      // Initialize
      updateCarousel();
      
      // Handle resize
      window.addEventListener('resize', () => {
        const newSlidesToShow = window.innerWidth >= 1200 ? 4 : window.innerWidth >= 768 ? 3 : window.innerWidth >= 480 ? 2 : 1;
        const newMaxIndex = Math.max(0, slides.length - newSlidesToShow);
        if (currentIndex > newMaxIndex) {
          currentIndex = newMaxIndex;
        }
        updateCarousel();
      });
    }
  });
</script>

{% schema %}
{
  "name": "Splash Carousel",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Rob's October Picks",
      "label": "Heading"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 4,
      "max": 12,
      "step": 1,
      "default": 8,
      "label": "Products to show"
    }
  ],
  "presets": [
    {
      "name": "Wine Carousel",
      "settings": {
        "heading": "Rob's October Picks"
      }
    }
  ]
}
{% endschema %}
